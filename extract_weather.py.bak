import os, json
from datetime import datetime
import requests
from dotenv import load_dotenv
load_dotenv()

API_KEY = os.getenv("OPENWEATHER_API_KEY")  # set in .env or your terminal
if not API_KEY:
    raise SystemExit("Missing OPENWEATHER_API_KEY env var")

cities = [
    "Fredericton,CA",
    "Moncton,CA",
    "Saint John,CA",
    "Miramichi,CA",
    "Bathurst,CA",
    "Edmundston,CA",
    "Campbellton,CA",
    "Woodstock,CA",
    "Dieppe,CA",
]

os.makedirs("data/raw", exist_ok=True)

run_ts = datetime.now().strftime("%Y%m%d_%H%M%S")
out_path = f"data/raw/weather_nb_{run_ts}.json"

results = []
for city in cities:
    url = (
        "https://api.openweathermap.org/data/2.5/weather"
        f"?q={city}&units=metric&appid={API_KEY}"
    )
    r = requests.get(url, timeout=30)
    results.append({"query": city, "status": r.status_code, "data": r.json()})

with open(out_path, "w", encoding="utf-8") as f:
    json.dump(results, f, indent=2)

print("Saved:", out_path)
print("Cities pulled:", len(results))
